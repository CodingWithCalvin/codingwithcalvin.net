---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import BaseLayout from './BaseLayout.astro';
import CategoryBadges from '../components/CategoryBadges.astro';
import YouTubeEmbed from '../components/YouTubeEmbed.astro';
import BlueskyEngagement from '../components/BlueskyEngagement.astro';

interface Props {
  title: string;
  slug: string;
  date: Date;
  categories: string[];
  description?: string;
  image?: ImageMetadata;
  youtube?: string;
  blueskyPostId?: string;
}

const { title, slug, date, categories, description, image, youtube, blueskyPostId } = Astro.props;

const formattedDate = date.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
  timeZone: 'America/New_York'
});

const postUrl = `https://www.codingwithcalvin.net/${slug}/`;

// Get the image URL for OG tags - use the src property from ImageMetadata
const ogImageUrl = image?.src;
---

<BaseLayout title={title} description={description} image={ogImageUrl} type="article">
  <article class="py-12">
    <div class="container mx-auto px-4 max-w-3xl relative md:pl-8">
      <div class="absolute left-0 top-0 bottom-0 w-2 bg-gradient-to-b from-primary via-primary/50 to-transparent rounded-full hidden md:block"></div>
      <header class="mb-8">
        <time class="text-text-muted text-sm">{formattedDate}</time>
        <h1 class="text-4xl font-heading mt-2 mb-4">{title}</h1>
        <CategoryBadges categories={categories} />
      </header>

      {youtube && (
        <div class="mb-8">
          <YouTubeEmbed url={youtube} title={title} />
        </div>
      )}

      {!youtube && image && (
        <div class="mb-8 rounded-lg overflow-hidden">
          <Image
            src={image}
            alt={title}
            class="w-full"
          />
        </div>
      )}

      <div class="prose prose-lg max-w-none">
        <slot />
      </div>

      <blockquote class="mt-12 border-l-4 border-primary bg-background-2 rounded-r-lg p-6 text-center">
        <p class="text-text-muted italic">
          This post, "{title}", first appeared on<br />
          <a href={postUrl} class="text-primary hover:underline">{postUrl}</a>
        </p>
      </blockquote>

      <hr class="mt-12 border-t border-text-muted/30" />

      {blueskyPostId && (
        <>
          <BlueskyEngagement postId={blueskyPostId} />
          <hr class="mt-12 border-t border-text-muted/30" />
        </>
      )}

      <section class="mt-8">
        <h2 class="text-2xl font-heading mb-6">Comments <span id="comment-count" class="text-text-muted text-lg font-normal"></span></h2>
        <script
          src="https://giscus.app/client.js"
          data-repo="CodingWithCalvin/codingwithcalvin.net"
          data-repo-id="R_kgDOIdGZXw"
          data-category="Blog Post Comments"
          data-category-id="DIC_kwDOIdGZX84C0RR6"
          data-mapping="og:title"
          data-strict="1"
          data-reactions-enabled="0"
          data-emit-metadata="1"
          data-input-position="top"
          data-theme="https://www.codingwithcalvin.net/giscus-theme.css"
          data-lang="en"
          data-loading="lazy"
          crossorigin="anonymous"
          async
        ></script>
        <script>
          function handleGiscusMessage(event) {
            if (!(typeof event.data === 'object' && event.data.giscus)) return;

            const giscusData = event.data.giscus;
            const countEl = document.getElementById('comment-count');

            if (giscusData.discussion) {
              const count = giscusData.discussion.totalCommentCount;
              if (countEl && count !== undefined) {
                countEl.textContent = `(${count})`;
              }
            } else if (countEl) {
              // No discussion yet = 0 comments
              countEl.textContent = '(0)';
            }
          }
          window.addEventListener('message', handleGiscusMessage);
        </script>
      </section>
    </div>
  </article>
</BaseLayout>
