---
import type { GetStaticPaths } from 'astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import Pagination from '../../components/Pagination.astro';
import { getProjectsWithStats, getProjectSlug } from '../../lib/projects';

export const getStaticPaths = (async ({ paginate }) => {
  const allProjects = await getProjectsWithStats();
  // Sort by GitHub stars (highest first), using live stats when available
  const sortedProjects = allProjects.sort((a, b) => {
    const aStars = a.githubStats?.stars ?? a.data.stars ?? 0;
    const bStars = b.githubStats?.stars ?? b.data.stars ?? 0;
    return bStars - aStars;
  });

  return paginate(sortedProjects, { pageSize: 9 });
}) satisfies GetStaticPaths;

const { page } = Astro.props;
---

<BaseLayout title="Open Source Projects" description="Open source projects by Calvin Allen" image="/images/projects-og.png">
  <section class="py-12">
    <div class="container mx-auto px-4">
      <h1 class="text-4xl font-heading mb-4">Open Source Projects</h1>
      <p class="text-text-muted text-lg mb-8">
        A collection of open source projects I've created and maintain, sorted by GitHub stars.
      </p>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {page.data.map(project => {
          const stars = project.githubStats?.stars ?? project.data.stars;
          const downloads = project.marketplaceStats?.downloads ?? project.marketplaceStats?.installs ?? project.data.downloads;
          return (
            <ProjectCard
              title={project.data.title}
              slug={getProjectSlug(project.id)}
              description={project.data.description}
              techStack={project.data.techStack}
              repoUrl={project.data.repoUrl}
              image={project.resolvedImage}
              stars={stars}
              downloads={downloads}
            />
          );
        })}
      </div>

      {page.lastPage > 1 && (
        <Pagination
          currentPage={page.currentPage}
          totalPages={page.lastPage}
          baseUrl="/projects/"
        />
      )}
    </div>
  </section>
</BaseLayout>
